# Delphes LLP

The file [DelphesLLP.tar.gz](./DelphesLLP.tar.gz) contains a modified Delphes 3.5.0 version with one new module and a few add-ons 
to the FastJetFinder module which might be useful for recasting LLP searches.

The new module is called BSMFilter and allows to filter BSM particles based on any of the following attributes:

  * Particle mass: set by the massMin parameter
  * Particle charge: set by the Charge parameter
  * Particle pdg: set by the PdgCode parameter
  * Particle status: set by the StatusCode parameter
  
The generator level particles satisfying the required criteria will be stored in the output array as well as their mother, their direct daughters (daughters coming from its decay)
and the final daughters (all stable particles generated by its decay). This module allows one to gather information about decayed LLPs and their decay position
can be obtained from their direct daughters production position.

Below we show an example of how the BSMFilter can be used in the Delphes card:

```
# BSM Filter
#####################

module BSMFilter LLPFilter {

  set InputArray Delphes/allParticles
  set OutputArray bsmParticles
  set MothersArray mothers
  set FinalDaughtersArray finalDaughters  
  set DirectDaughtersArray directDaughters  
  set PTMin 0.0
  set massMin 50.0
  
  # Select sbottoms
  add PdgCode {1000005}
  add PdgCode {-1000005}
}
```

When dealing with long-lived particles carrying color one must need the respective R-hadron associated with the LLP.
For decaying particles/R-hadrons this information is stored in the *mothers* array.
However, for stable (undecayed) particles/R-hadrons, the R-hadron will show up in the finalDaughters array, since it is an stable particle in the event.
The particles stored in the arrays have their mother and daughter indices modified so they correspond to the new arrays (mother, finalDaughters, ...) indices.


In addition to the new module, new variables have been included in the Jet Class:

 * MaxPVDist: Maximum track transverse displacement (in mm) for a track to be considered as coming from the Primary Vertex (PV).
 * ChargedPTPV: the scalar sum of charged tracks PT with a transverse displacement smaller than MaxPVDist.
 * MaxTrackRDV: maximum track transverse displacement (in mm) for a track to be included in the jet.
 * RemoveDispTracks: If set to True, tracks with a transverse displacement larged than MaxTrackRDV will not be included for jet clustering
  
 The above variables are used for identifying displaced jets or removing displaced tracks from prompt jets.
 
 One example of how to use the new Jet features in the Delphes card is shown below:
 
 ```
 #####################
# MC truth jet finder
#####################

module FastJetFinder GenJetFinder {
  set InputArray JetFilter/filteredParticles

  set OutputArray jets

  # algorithm: 1 CDFJetClu, 2 MidPoint, 3 SIScone, 4 kt, 5 Cambridge/Aachen, 6 antikt
  set JetAlgorithm 6
  set ParameterR 0.4

  set JetPTMin 20.0
  # Maximum transverse distance of jet constituent to be counted in the ChargedPTPV variable
  set MaxPVDist 2.0
  
  set RemoveDispTracks True
  set MaxTrackRDV 4.0
  
}
```


