# Displaced Vertex Recasting #

## Authors: ##
[Andre Lessa](mailto:andre.lessa@ufabc.edu.br)

This repository holds the main code for recasting the 13 TeV ATLAS search for displaced vertices
plus missing energy ([ATLAS-SUSY-2016-08](https://atlas.web.cern.ch/Atlas/GROUPS/PHYSICS/PAPERS/SUSY-2016-08/))
using the efficiency grids  for event and vertex reconstruction selection provided [here](https://atlas.web.cern.ch/Atlas/GROUPS/PHYSICS/PAPERS/SUSY-2016-08/hepdata_info.pdf).

## Pre-Requisites ##

The following pre-requisites must be installed before compiling the main code:

  * [MadGraph5](https://launchpad.net/mg5amcnlo) with [Pythia8](https://pythia.org/) installed
  * [Modified Delphes](./DelphesLLP.tar.gz)
  
## Installation ##

Running:

```
./installer.sh
```

Should install most of the relevant (non-Mathematica) packages.
The LHAPDF, Pythia8 and Delphes directories must be included in the library and root include paths.
This can be done running:

```
source setenv.sh
```

## Running ##

The recasting accepts ROOT files generated by the modified Delphes version provided in this repository.
Examples of Delphes cards can be found in the [validation/Cards](./validation/Cards) folder.
*Note that the LLP PDG ids have to be defined in the BSMFilter block of the delphes card, so the required
LLP information is stored in the ROOT file*.
The main recasting code accepts the following options:

```
usage: atlas_susy_2016_13_Recast.py [-h] -f INPUTFILE [INPUTFILE ...] [-o OUTPUTFILE] [-n] [-v VERBOSE]

Run the recasting for ATLAS-SUSY-2018-13 using one or multiple Delphes ROOT files as input. If multiple files are given as argument, add them (the samples weights will be normalized if -n is given).
Store the cutflow and SR bins in a pickle (Pandas DataFrame) file.

options:
  -h, --help            show this help message and exit
  -f INPUTFILE [INPUTFILE ...], --inputFile INPUTFILE [INPUTFILE ...]
                        path to the ROOT event file(s) generated by Delphes.
  -o OUTPUTFILE, --outputFile OUTPUTFILE
                        path to output file storing the DataFrame with the recasting data. If not defined, will use the name of the first input file
  -n, --normalize       If set, the input files will be considered to refer to multiple samples of the same process and their weights will be normalized.
  -v VERBOSE, --verbose VERBOSE
                        verbose level (debug, info, warning or error). Default is info

```

The basic required input is a Delphes ROOT file.
For instance, running:

```
./atlas_susy_2016_08_Recast.py -f <root file>
```
will produce a pickle file contaning a Pandas DataFrame with a simplified cutflow and the number of events in each signal region.

## Validation ##


The validation of the signal efficiencies (efficiency times acceptance)
for direct production of staus can be found in the [validation folder](validation).
The output (.eff files) was generated using the SLHA files and pythia8.cfg and parameters.ini files stored in the folder.
For instance, the following validation plot can be generated running this [ipython notebook](validation/validation-mlsp100.ipynb):

 * mgluino = 1.4 TeV, mLSP = 100 GeV:

![Alt text](validation/validationPlot_mlsp100.png?raw=true "Validation Plot")


* mgluino = 1.4 TeV, mLSP = 1300 GeV:

![Alt text](validation/validationPlot_dm100.png?raw=true "Validation Plot")

* mgluino = 1.4 TeV, tau = 1 ns:

![Alt text](validation/validationPlot_mgluino1400_tau1ns.png?raw=true "Validation Plot")



### Cut-flow Comparison


|             | ATLAS  | Recasting  |   ATLAS | Recasting  |
| ----------- | ------ | ---------- | ------- | ---------- |
|  **mGluino, mLSP, tau**             | **2000,100,1ns**  | **2000,100,1ns**  |   **2000,1800,1ns** | **2000,1800,1ns**  |
| Initial Events                 |   32   |   32   |   32   |   32  |
| Trigger-based data reduction   |   32   |        |   27   |       |
| Event cleaning                 |   32   |        |   27   |       |
| Good Runs List   |   32   |   --   |   27   |   --  |
| Primary vertex   |   32   |   --   |   27   |   --  |
| NCB veto   |   32   |   --   |   26   |   --  |
| MET trigger   |   31   |   --   |   24   |   --  |
| MET filter (MET > 200 GeV for recast)   |   31   |   30.4   |   17   |   15  |
| Offline MET (event selection eff. for recast)   |   29   |   26.8   |   7   |  9.3  |
|  |
| DV fiducial acceptance   |   28   |   --   |   6   |   --  |
| DV fit quality   |   27   |   --   |   6   |   --  |
| DV displacement   |   27   |   --   |   6   |   --  |
| Material veto   |   22   |   --   |   5   |   --  |
| Disabled module veto   |   22   |   --   |   5   |   --  |
| DV track multplicity   |   15   |   --   |   3   |   --  |
| DV mass (vertex level eff. for recast)   |   14   |   14.4   |   2   |   3.6  | 

